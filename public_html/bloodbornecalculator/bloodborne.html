<html>
<head>
	<title>Bloodborne Skill Calculator</title>
	<link rel='stylesheet' type='text/css' href='stylesheet.css' />
</head>

<body>
	<div id='main'>
		<div class='centered'>
			<div id='main_container'>
				<!-- left column -->
				<div class='stat_container' id='core_stats'>
					<div id='origin'>
						<br/><br/>
						<span>Origin: </span>
						<select id='originselect'>
							<option>Milquetoast</option>
							<option>Lone Survivor</option>
							<option>Violent Past</option>
							<option>Professional</option>
							<option>Military Veteran</option>
							<option>Noble Scion</option>
							<option>Cruel Fate</option>
							<option>Waste of Skin</option>
						</select>
					</div>
					<div class='core_stat_container' id='core_stat_names'>
						<div class='stat_item'><div class='centered'></div></div>
						<div class='stat_item'><div class='centered'>Level</div></div>
						<div class='stat_item'><div class='centered'>Blood Echoes</div></div>
						<div class='stat_item'><div class='centered'></div></div>
						<div class='stat_item'><div class='centered'>Vitality</div></div>
						<div class='stat_item'><div class='centered'>Endurance</div></div>
						<div class='stat_item'><div class='centered'>Strength</div></div>
						<div class='stat_item'><div class='centered'>Skill</div></div>
						<div class='stat_item'><div class='centered'>Bloodtinge</div></div>
						<div class='stat_item'><div class='centered'>Arcane</div></div>
					</div>
					<div class='core_stat_container' id='initial'>
						<div class='stat_item'><div class='centered'>Starting</div></div>
						<div class='stat_item'><div class='centered' id='initlvl'></div></div>
						<div class='stat_item'><div class='centered'></div></div>
						<div class='stat_item'><div class='centered'></div></div>
						<div class='stat_item'><div class='centered'><input type='number' min='1' max='99' id='initvit'></div></div>
						<div class='stat_item'><div class='centered'><input type='number' min='1' max='99' id='initend'></div></div>
						<div class='stat_item'><div class='centered'><input type='number' min='1' max='99' id='initstr'></div></div>
						<div class='stat_item'><div class='centered'><input type='number' min='1' max='99' id='initski'></div></div>
						<div class='stat_item'><div class='centered'><input type='number' min='1' max='99' id='initbld'></div></div>
						<div class='stat_item'><div class='centered'><input type='number' min='1' max='99' id='initarc'></div></div>
					</div>
					<div class='core_stat_container' id='final'>
						<div class='stat_item'><div class='centered'>Final</div></div>
						<div class='stat_item'><div class='centered' id='finallvl'></div></div>
						<div class='stat_item'><div class='centered' id='bloodechoes'>1,000,000</div></div>
						<div class='stat_item'><div class='centered'></div></div>
						<div class='stat_item'><div class='centered'><input type='number' min='1' max='99' id='finalvit'></div></div>
						<div class='stat_item'><div class='centered'><input type='number' min='1' max='99' id='finalend'></div></div>
						<div class='stat_item'><div class='centered'><input type='number' min='1' max='99' id='finalstr'></div></div>
						<div class='stat_item'><div class='centered'><input type='number' min='1' max='99' id='finalski'></div></div>
						<div class='stat_item'><div class='centered'><input type='number' min='1' max='99' id='finalbld'></div></div>
						<div class='stat_item'><div class='centered'><input type='number' min='1' max='99' id='finalarc'></div></div>
					</div>
				</div>
				<!-- middle column -->
				<div class='stat_container' id='weapon_stats'>
					<div class='weapon_container' id='right_hand'>
						<div class='weapon_select' id='rhandselect'>
							<div style='width:100%;height:50%;padding-top:20px'>Right Hand</div>
							<div style='width:50%;height:50%;float:left'>Hey</div>
							<div style='width:50%;height:50%;float:left'>
								<select class='weaponname'>
									<option>Saw Cleaver</option>
									<option>Threaded Cane</option>
								</select>
								<select class='weaponupgrade'>
									<option>+0</option>
									<option>+1</option>
									<option>+2</option>
									<option>+3</option>
									<option>+4</option>
									<option>+5</option>
									<option>+6</option>
									<option>+7</option>
									<option>+8</option>
									<option>+9</option>
									<option>+10</option>
								</select>
							</div>
						</div>
						<div class='weapon_info' id='rhandinfo'>
							<div>Scaling:</div>
							<br/>
							<div style='width:25%;float:left' class='str'>C</div>
							<div style='width:25%;float:left' class='ski'>C</div>
							<div style='width:25%;float:left' class='bld'>C</div>
							<div style='width:25%;float:left' class='arc'>C</div>
							<br/>
							<br/>
							<div class='base'>Base ATK: 128</div>
							<div class='final'>Final ATK: 256</div>
						</div>
					</div>
					<div class='weapon_container' id='left_hand'>
						<div class='weapon_select' id='lhandselect'>
							<div style='width:100%;height:50%;padding-top:20px'>Left Hand</div>
							<div style='width:50%;height:50%;float:left'>Hey</div>
							<div style='width:50%;height:50%;float:left'>
								<select class='weaponname'>
									<option>Saw Cleaver</option>
									<option>Threaded Cane</option>
								</select>
								<select class='weaponupgrade'>
									<option>+0</option>
									<option>+1</option>
									<option>+2</option>
									<option>+3</option>
									<option>+4</option>
									<option>+5</option>
									<option>+6</option>
									<option>+7</option>
									<option>+8</option>
									<option>+9</option>
									<option>+10</option>
								</select>
							</div>
						</div>
						<div class='weapon_info' id='lhandinfo'>
							<div>Scaling:</div>
							<br/>
							<div style='width:25%;float:left' class='str'>C</div>
							<div style='width:25%;float:left' class='ski'>C</div>
							<div style='width:25%;float:left' class='bld'>C</div>
							<div style='width:25%;float:left' class='arc'>C</div>
							<br/>
							<br/>
							<div class='base'>Base ATK: 128</div>
							<div class='final'>Final ATK: 256</div>
						</div>
					</div>
				</div>
				<!-- right column -->
				<div class='stat_container' id='status'>
					<div style='width:70%;float:left'>
						<div class='stat_item'><div class='centered'></div></div>
						<div class='stat_item'><div class='centered'>HP</div></div>
						<div class='stat_item'><div class='centered'>Stamina</div></div>
						<div class='stat_item'><div class='centered'>Discovery</div></div>
						<div class='stat_item'><div class='centered'></div></div>
						<div class='stat_item'><div class='centered'>Physical DEF</div></div>
						<div class='stat_item'><div class='centered'>Slow Poison RES</div></div>
						<div class='stat_item'><div class='centered'>Rapid Poison RES</div></div>
						<div class='stat_item'><div class='centered'>Frenzy RES</div></div>
						<div class='stat_item'><div class='centered'>Beasthood</div></div>
					</div>
					<div style='width:30%;float:left;'>
						<div class='stat_item'><div class='centered'></div></div>
						<div class='stat_item'><div class='centered' id='hp'></div></div>
						<div class='stat_item'><div class='centered' id='stam'></div></div>
						<div class='stat_item'><div class='centered' id='disc'></div></div>
						<div class='stat_item'><div class='centered'></div></div>
						<div class='stat_item'><div class='centered' id='physdef'></div></div>
						<div class='stat_item'><div class='centered' id='slowpois'></div></div>
						<div class='stat_item'><div class='centered' id='rapidpois'></div></div>
						<div class='stat_item'><div class='centered' id='frenzy'></div></div>
						<div class='stat_item'><div class='centered' id='beasthood'></div></div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src='underscore.js'></script>
	<script src='jquery.js'></script>
	<script src='backbone.js'></script>
	<script src='info.js'></script>
	<script type='text/template' id='weapon-select-template'>
		<div style='width:100%;height:50%;padding-top:20px'><%=hand%></div>
		<div style='width:50%;height:50%;float:left'>Img</div>
		<div style='width:50%;height:50%;float:left'>
			<select class='weaponname'>
				<option>Saw Cleaver</option>
				<option>Threaded Cane</option>
			</select>
			<select class='weaponupgrade'>
				<option value='0'>+0</option>
				<option value='1'>+1</option>
				<option value='2'>+2</option>
				<option value='3'>+3</option>
				<option value='4'>+4</option>
				<option value='5'>+5</option>
				<option value='6'>+6</option>
				<option value='7'>+7</option>
				<option value='8'>+8</option>
				<option value='9'>+9</option>
				<option value='10'>+10</option>
			</select>
		</div>
	</script>
	<script type='text/template' id='weapon-stat-template'>
		<div>Scaling:</div>
		<br/>
		<div style='width:25%;float:left' class='str'><%=strscl%></div>
		<div style='width:25%;float:left' class='ski'><%=skiscl%></div>
		<div style='width:25%;float:left' class='bld'><%=bldscl%></div>
		<div style='width:25%;float:left' class='arc'><%=arcscl%></div>
		<br/>
		<br/>
		<div class='base'>Base ATK: <%=baseatk%></div>
		<div class='final'>Final ATK: <%=finalatk%></div>
	</script>
	<script>
		var origins = 
			{
				"Milquetoast": {lvl: 10, vit: 11, end: 10, str: 12, ski: 10, bld: 9, arc: 8},
				"Lone Survivor": {lvl: 10, vit: 14, end: 11, str: 11, ski: 10, bld: 7, arc: 7},
				"Troubled Childhood": {lvl: 10, vit: 9, end: 14, str: 9, ski: 13, bld: 6, arc: 9},
				"Violent Past": {lvl: 10, vit: 12, end: 11, str: 15, ski: 9, bld: 6, arc: 7},
				"Professional": {lvl: 10, vit: 9, end: 12, str: 9, ski: 15, bld: 7, arc: 8} ,
				"Military Veteran": {lvl: 10, vit: 10, end: 10, str: 14, ski: 13, bld: 7, arc: 6},
				"Noble Scion": {lvl: 10, vit: 7, end: 8, str: 9, ski: 13, bld: 14, arc: 9},
				"Cruel Fate": {lvl: 10, vit: 10, end: 12, str: 10, ski: 9, bld: 5, arc: 14},
				"Waste of Skin": {lvl: 4, vit: 10, end: 9, str: 10, ski: 9, bld: 7, arc: 9}
			};

		var Character = Backbone.Model.extend( {
			defaults: {
				lvl: 0,
				vit: 0,
				end: 0,
				str: 0,
				ski: 0,
				bld: 0,
				arc: 0,
				//dependent on above stats; not user selected
				hp: 0,
				stam: 0,
				disc: 0,
				physdef: 0,
				slowpois: 0,
				rapidpois: 0,
				frenzy: 0,
				beasthood: 0,

				// reference to another Character instance; used for data validation
				startpoint: null

			},
			initialize: function() {
				console.log("Created a character");
				this.on('change:vit change:end change:str change:ski change:bld change:arc', this.updateLevel);
				this.on('change:vit', function(){
					this.set('hp', hpInfo[this.get('vit')]);
				});
				this.on('change:end', function(){
					console.log('hi');
					this.set('stam', stamInfo[this.get('end')]);
					this.set('slowpois', poisInfo[this.get('end')]);
					this.set('rapidpois', poisInfo[this.get('end')]);
				});
				this.on('change:str change:ski change:bld change:arc', this.updateAtk);
				this.on('change:arc', function(){
					this.set('disc', discInfo[this.get('arc')]);
				});
				this.on('change:lvl', function(){
					this.set('physdef', physdefInfo[this.get('lvl')]);
				});
				this.updateAll();
			},
			updateLevel: function() {
				var newLevel = this.get('vit') + this.get('end') + this.get('str') + this.get('ski') + this.get('bld') + this.get('arc') - 50;
				if (newLevel < 0) newLevel = 0;
				this.set('lvl', newLevel);
			},
			updateAll: function() {
				this.set('hp', hpInfo[this.get('vit')]);
				this.set('stam', stamInfo[this.get('end')]);
				this.set('slowpois', poisInfo[this.get('end')]);
				this.set('rapidpois', poisInfo[this.get('end')]);
				this.set('disc', discInfo[this.get('arc')]);
				this.set('physdef', physdefInfo[this.get('lvl')]);
				this.updateLevel();
			},
			//checks that these stats are higher than the initial stats
			validate: function(stat) {
				if (this.startpoint === null) return true;
				return (this.get(stat) <= 99 && this.get(stat) >= this.get('startpoint').get(stat));
			},
			validateAll: function() {
				return (this.validate('vit') &&
						this.validate('end') &&
						this.validate('str') &&
						this.validate('ski') &&
						this.validate('bld') &&
						this.validate('arc'));
			},

			reset: function() {
				var startpoint = this.get('startpoint');
				var newStats = {};
				newStats.vit = startpoint.get('vit');
				newStats.end = startpoint.get('end');
				newStats.str = startpoint.get('str');
				newStats.ski = startpoint.get('ski');
				newStats.bld = startpoint.get('bld');
				newStats.arc = startpoint.get('arc');
				this.set(newStats);
			}
		});

		//View for main stats (vit, end, str, etc)
		var PrimaryStatView = Backbone.View.extend({
			//passed in: element, render, name
			initialize: function(options) {
				this.name = options.name;
				this.listenTo(this.model, 'change:' + this.name, this.updateColor);
				this.listenTo(this.model, 'change:' + this.name, this.setVal);
				if (this.model.get('startpoint') !== null)
					this.listenTo(this.model.get('startpoint'), 'change:' + this.name, this.updateColor);
				this.setVal();

			},
			events: {
				'change': 'updateStat'
			},
			//passes user input back into model
			updateStat: function() {
				console.log("Change detected");
				this.model.set(this.name, parseInt(this.$el.val()));
			},
			//changes the value of the input field
			setVal: function() {
				this.$el.val(this.model.get(this.name));
			},
			updateColor: function(){
				this.$el.toggleClass('invalid', !this.model.validate(this.name));
			}
		});

		//View for secondary stats (HP, resistances, etc)
		var SecondaryStatView = Backbone.View.extend({
			initialize: function(options) {
				this.name = options.name;
				this.listenTo(this.model, 'change:' + this.name, this.render);
				this.render();
			},
			render: function() {
				this.$el.html(this.model.get(this.name));
			}
		});

		var Weapon = Backbone.Model.extend( {
			defaults: {
				name: '',
				hand: '',
				lvl: 0,
				strscl: 'E',
				skiscl: 'E',
				bldscl: 'E',
				arcscl: 'E',
				baseatk: 0,
				finalatk: 0,
				character: null,

				//an array of objects with stats for each upgrade level, indexed 0 to 10
				scalingInfo: null
			},
			initialize: function() {
				this.on('change:lvl', function() {
					this.set(this.get('scalingInfo')[this.get('lvl')]);
					this.updateAtk();
				});
				this.on('change:name', function() {
					this.set('scalingInfo', weaponInfo[this.get('name')]);
					this.set(this.get('scalingInfo')[this.get('lvl')]);
					this.updateAtk();
				});
				this.listenTo(this.get('character'), 'change', this.updateAtk);
				this.set(this.get('scalingInfo')[this.get('lvl')]);
				this.updateAtk();
			},
			updateAtk: function() {
				//Final Attack = Base Attack + (Base Attack * Scaling Ratio * Attribute Rating)
				var character = this.get('character');
				if (character === undefined)
				{
					this.set('baseatk', 0);
					this.set('finalatk', 0);
				}
				else
				{
					var base = this.get('baseatk');
					var newFinal = this.get('baseatk');
					if (this.get('strscl') !== '-')
						newFinal += (base * scalingRatio[this.get('strscl')] * attributeRating[character.get('str')]);
					if (this.get('skiscl') !== '-')
						newFinal += (base * scalingRatio[this.get('skiscl')] * attributeRating[character.get('ski')]);
					if (this.get('bldscl') !== '-')
						newFinal += (base * scalingRatio[this.get('bldscl')] * attributeRating[character.get('bld')]);
					if (this.get('arcscl') !== '-')
						newFinal += (base * scalingRatio[this.get('arcscl')] * attributeRating[character.get('arc')]);
					this.set('finalatk', Math.floor(newFinal));
				}
			},
		});


		var Weapons = Backbone.Collection.extend( {
			model: Weapon
		});

		var WeaponSelect = Backbone.View.extend( {
			template: _.template($('#weapon-select-template').html()),
			initialize: function() {
				this.render();
			},
			render: function() {
				this.$el.html(this.template(this.model.toJSON()));
			},
			events: {
				'change .weaponupgrade': function() {
					var upgrade = this.$('.weaponupgrade option:selected').text()[1];
					this.model.set('lvl', parseInt(upgrade));
				},
				'change .weaponname': function() {
					var newName = this.$('.weaponname option:selected').text();
					this.model.set('name', newName);
					var upgrade = this.$('.weaponupgrade option:selected').text()[1];
					this.model.set('lvl', parseInt(upgrade));
				} 
			}
		});

		var WeaponStatView = Backbone.View.extend( {
			template: _.template($('#weapon-stat-template').html()),
			initialize: function() {
				this.listenTo(this.model, 'change', this.render);
				this.render();
			},
			render: function() {
				this.$el.html(this.template(this.model.toJSON()));
			}
		});

		//selected from dropdown menu
		var baseChar = new Character(origins["Milquetoast"]);
		//left column; must be >= baseChar's stats
		var initChar = new Character(origins["Milquetoast"]);
		initChar.set('startpoint', baseChar);
		//when the base char changes, reset the initial character
		initChar.listenTo(baseChar, 'change', initChar.reset);
		//right column; must be >= initChar's stats
		var finalChar = new Character(origins["Milquetoast"]);
		finalChar.set('startpoint', initChar);

		//set up weapons
		var weapons = new Weapons;

		weapons.add([
			new Weapon({
				name: 'Saw Cleaver',
				lvl: 0,
				scalingInfo: weaponInfo['Saw Cleaver'],
				character: finalChar
			}),
			new Weapon({
				name: 'Threaded Cane',
				lvl: 0,
				scalingInfo: weaponInfo['Threaded Cane'],
				character: finalChar
			})
		]);
		
		var leftHand = new Weapon({hand: 'Left Hand', name: 'Saw Cleaver', lvl: 0, scalingInfo: weaponInfo['Saw Cleaver'], character: finalChar});
		var rightHand = new Weapon({hand: 'Right Hand', name: 'Saw Cleaver', lvl: 0, scalingInfo: weaponInfo['Saw Cleaver'], character: finalChar});

		var leftHandSelect = new WeaponSelect({el: $('#lhandselect'), model: leftHand});
		var rightHandSelect = new WeaponSelect({el: $('#rhandselect'), model: rightHand});

		var leftHandStats = new WeaponStatView({el: $('#lhandinfo'), model: leftHand});
		var rightHandStats = new WeaponStatView({el: $('#rhandinfo'), model: rightHand});

		//set up stat views
		var initlvl = new SecondaryStatView({el: $('#initlvl'), model: initChar, name: 'lvl'});
		var finallvl = new SecondaryStatView({el: $('#finallvl'), model: finalChar, name: 'lvl'});
		var hp = new SecondaryStatView({el: $('#hp'), model: finalChar, name: 'hp'});
		var stam = new SecondaryStatView({el: $('#stam'), model: finalChar, name: 'stam'});
		var disc = new SecondaryStatView({el: $('#disc'), model: finalChar, name: 'disc'});
		var physdef = new SecondaryStatView({el: $('#physdef'), model: finalChar, name: 'physdef'});
		var slowpois = new SecondaryStatView({el: $('#slowpois'), model: finalChar, name: 'slowpois'});
		var rapidpois = new SecondaryStatView({el: $('#rapidpois'), model: finalChar, name: 'rapidpois'});
		var frenzy = new SecondaryStatView({el: $('#frenzy'), model: finalChar, name: 'frenzy'});
		var beasthood = new SecondaryStatView({el: $('#beasthood'), model: finalChar, name: 'beasthood'});

		//initial stats
		var initvit = new PrimaryStatView({el: $('#initvit'), model: initChar, name: 'vit'});
		var initend = new PrimaryStatView({el: $('#initend'), model: initChar, name: 'end'});
		var initstr = new PrimaryStatView({el: $('#initstr'), model: initChar, name: 'str'});
		var initski = new PrimaryStatView({el: $('#initski'), model: initChar, name: 'ski'});
		var initbld = new PrimaryStatView({el: $('#initbld'), model: initChar, name: 'bld'});
		var initarc = new PrimaryStatView({el: $('#initarc'), model: initChar, name: 'arc'});
		//final stats
		var finalvit = new PrimaryStatView({el: $('#finalvit'), model: finalChar, name: 'vit'});
		var finalend = new PrimaryStatView({el: $('#finalend'), model: finalChar, name: 'end'});
		var finalstr = new PrimaryStatView({el: $('#finalstr'), model: finalChar, name: 'str'});
		var finalski = new PrimaryStatView({el: $('#finalski'), model: finalChar, name: 'ski'});
		var finalbld = new PrimaryStatView({el: $('#finalbld'), model: finalChar, name: 'bld'});
		var finalarc = new PrimaryStatView({el: $('#finalarc'), model: finalChar, name: 'arc'});

		var BloodEchoesView = Backbone.View.extend({
			el: $('#bloodechoes'),
			initialize: function() {
				this.listenTo(finalChar, 'change:lvl', this.render);
				this.listenTo(initChar, 'change:lvl', this.render);
				this.render();
			},
			render: function() {
				var cost = levelCost(finalChar.get('lvl')) - levelCost(initChar.get('lvl'));
				if (cost < 0) cost = 0;
				this.$el.html(cost);
			}
		});
		var bloodEchoesView = new BloodEchoesView;

		var OriginSelector = Backbone.View.extend({
			el: $('#originselect'),
			model: baseChar,
			events: {
				'change': 'changeOrigin'
			},
			changeOrigin: function() {
				var origin = $('#originselect option:selected').text();
				this.model.set(origins[origin]);
			}
		});
		var originSelector = new OriginSelector;

	</script>

</body>

</html>